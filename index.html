<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrganizadorFiestas - 50 Aniversario</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            text-align: center;
            padding: 30px;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .db-status {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .db-connected {
            background: rgba(46, 213, 115, 0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #19547b;
            border-bottom-color: #19547b;
        }
        
        .tab-content {
            padding: 30px;
            min-height: 600px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #19547b 0%, #ffd89b 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #19547b;
            box-shadow: 0 0 0 2px rgba(25, 84, 123, 0.2);
        }
        
        .currency {
            text-align: right;
            font-weight: 500;
        }
        
        .pending {
            background: #fee;
            color: #c53030;
            font-weight: bold;
        }
        
        .positive-diff {
            color: #38a169;
            font-weight: bold;
        }
        
        .negative-diff {
            color: #c53030;
            font-weight: bold;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .summary-item h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .summary-item .amount {
            font-size: 2em;
            font-weight: bold;
            margin: 0;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #19547b 0%, #ffd89b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px 5px;
            transition: transform 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
        }
        
        .add-row {
            margin: 20px 0;
            text-align: center;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .total-row {
            background: #f8f9fa;
            font-weight: bold;
            border-top: 2px solid #19547b;
        }
        
        .export-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .action-buttons {
            display: inline-flex;
            gap: 5px;
            white-space: nowrap;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 60px;
        }
        
        .completed-task {
            background: #e8f5e8;
            opacity: 0.8;
        }
        
        .high-priority {
            border-left: 4px solid #ff4757;
        }
        
        .medium-priority {
            border-left: 4px solid #ffa502;
        }
        
        .low-priority {
            border-left: 4px solid #2ed573;
        }
        
        .confirmed {
            background: #e8f5e8;
            color: #27ae60;
            font-weight: bold;
        }
        
        .declined {
            background: #fee;
            color: #c53030;
            font-weight: bold;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .completed-task {
            background: #e8f5e8;
            opacity: 0.8;
        }
        
        .high-priority {
            border-left: 4px solid #ff4757;
        }
        
        .medium-priority {
            border-left: 4px solid #ffa502;
        }
        
        .low-priority {
            border-left: 4px solid #2ed573;
        }
        
        .confirmed {
            background: #e8f5e8;
            color: #27ae60;
            font-weight: bold;
        }
        
        .declined {
            background: #fee;
            color: #c53030;
            font-weight: bold;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .filter-active {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%) !important;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #19547b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mejoras adicionales para responsive */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab {
                min-width: 120px;
                font-size: 14px;
                padding: 12px 15px;
            }
            
            table {
                font-size: 12px;
                min-width: 800px;
            }
            
            .tab-content {
                overflow-x: auto;
                padding: 15px;
            }
            
            th, td {
                padding: 8px 6px;
                min-width: 80px;
            }
            
            input, select {
                font-size: 12px;
                padding: 6px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 16px;
                margin: 5px 2px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .summary-item .amount {
                font-size: 1.5em;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .db-status {
                position: static;
                margin: 10px auto;
                display: inline-block;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                font-size: 12px;
                padding: 10px 8px;
                min-width: 100px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            table {
                font-size: 11px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .export-section {
                padding: 15px;
            }
            
            .instructions {
                font-size: 14px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="db-status" id="dbStatus">
                <span class="loading"></span> Inicializando BD...
            </div>
            <h1>üéâ Organizador de Fiesta</h1>
            <p>50 Aniversario de Bodas - Versi√≥n GitHub Pages</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('aportes')">üí∞ Aportes de la Familia</button>
            <button class="tab" onclick="showTab('gastos')">üí∏ Gastos de la Fiesta</button>
            <button class="tab" onclick="showTab('tareas')">üìù Tareas</button>
            <button class="tab" onclick="showTab('invitados')">üë• Invitados</button>
            <button class="tab" onclick="showTab('resumen')">üìä Resumen General</button>
        </div>
        
        <div class="tab-content">
            <!-- HOJA 1: APORTES DE LA FAMILIA -->
            <div id="aportes" class="tab-pane active">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Registra los aportes de cada familiar. Los datos se guardan autom√°ticamente en tu navegador (localStorage + SQLite). Haz respaldos regulares usando "Exportar Base de Datos". Los saldos pendientes aparecen resaltados en rojo.
                </div>
                
                <table id="tablaAportes">
                    <thead>
                        <tr>
                            <th>Nombre del Integrante</th>
                            <th>Monto Comprometido</th>
                            <th>Monto Entregado</th>
                            <th>Fecha de Aporte</th>
                            <th>Forma de Pago</th>
                            <th>Observaciones</th>
                            <th>Saldo Pendiente</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde SQLite -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevoAporte()">‚ûï Agregar Familiar</button>
                </div>
            </div>
            
            <!-- HOJA 2: GASTOS DE LA FIESTA -->
            <div id="gastos" class="tab-pane">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Registra todos los gastos de la fiesta por categor√≠as. Los datos se almacenan autom√°ticamente en SQLite. La diferencia entre costo estimado y real se calcula autom√°ticamente.
                </div>
                
                <table id="tablaGastos">
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Proveedor</th>
                            <th>Costo Estimado</th>
                            <th>Costo Real</th>
                            <th>Diferencia</th>
                            <th>Fecha de Pago</th>
                            <th>Pagado Por</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde SQLite -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>TOTALES</strong></td>
                            <td></td>
                            <td class="currency" id="totalEstimado">‚Ç°0.00</td>
                            <td class="currency" id="totalReal">‚Ç°0.00</td>
                            <td class="currency" id="totalDiferencia">‚Ç°0.00</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevoGasto()">‚ûï Agregar Gasto</button>
                </div>
            </div>
            
            <!-- HOJA 3: TAREAS -->
            <div id="tareas" class="tab-pane">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Organiza todas las tareas necesarias para la fiesta. Asigna responsables, categoriza por tipo y marca como completadas cuando est√©n listas.
                </div>
                
                <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;" class="filter-buttons">
                    <button class="btn filter-active" onclick="filtrarTareas('todas')" id="btnTodas">üìã Todas</button>
                    <button class="btn" onclick="filtrarTareas('pendientes')" id="btnPendientes">‚è≥ Pendientes</button>
                    <button class="btn" onclick="filtrarTareas('finalizadas')" id="btnFinalizadas">‚úÖ Finalizadas</button>
                </div>
                
                <table id="tablaTareas">
                    <thead>
                        <tr>
                            <th>Tarea</th>
                            <th>Categor√≠a</th>
                            <th>Responsable</th>
                            <th>Fecha L√≠mite</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde SQLite -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevaTarea()">‚ûï Agregar Tarea</button>
                </div>
            </div>
            
            <!-- HOJA 4: INVITADOS -->
            <div id="invitados" class="tab-pane">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Gestiona la lista de invitados, controla confirmaciones y necesidades especiales. Mant√©n organizado qui√©n viene y sus detalles importantes.
                </div>
                
                <div class="summary-card" style="margin: 20px 0;">
                    <div class="summary-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="summary-item">
                            <h3>Total Invitados</h3>
                            <p class="amount" id="totalInvitados">0</p>
                        </div>
                        <div class="summary-item">
                            <h3>Confirmados</h3>
                            <p class="amount" id="totalConfirmados">0</p>
                        </div>
                        <div class="summary-item">
                            <h3>Pendientes</h3>
                            <p class="amount" id="totalPendientes">0</p>
                        </div>
                        <div class="summary-item">
                            <h3>No Asisten</h3>
                            <p class="amount" id="totalNoAsisten">0</p>
                        </div>
                    </div>
                </div>
                
                <table id="tablaInvitados">
                    <thead>
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Relaci√≥n</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Estado</th>
                            <th>Acompa√±antes</th>
                            <th>Necesidades Especiales</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde SQLite -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevoInvitado()">‚ûï Agregar Invitado</button>
                </div>
            </div>
            
            <!-- HOJA 5: RESUMEN GENERAL -->
            <div id="resumen" class="tab-pane">
                <div class="summary-card">
                    <h2 style="text-align: center; margin-bottom: 30px;">üìä Resumen Financiero</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <h3>Aportes Comprometidos</h3>
                            <p class="amount" id="totalComprometido">‚Ç°0.00</p>
                        </div>
                        <div class="summary-item">
                            <h3>Aportes Recibidos</h3>
                            <p class="amount" id="totalRecibido">‚Ç°0.00</p>
                        </div>
                        <div class="summary-item">
                            <h3>Gastos Estimados</h3>
                            <p class="amount" id="resumenEstimado">‚Ç°0.00</p>
                        </div>
                        <div class="summary-item">
                            <h3>Gastos Reales</h3>
                            <p class="amount" id="resumenReal">‚Ç°0.00</p>
                        </div>
                        <div class="summary-item" style="grid-column: 1 / -1;">
                            <h3>Balance Final</h3>
                            <p class="amount" id="balanceFinal">‚Ç°0.00</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>üìà Estad√≠sticas</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div id="estadisticasAportes">
                            <h4>üìä Aportes por Estado</h4>
                            <div id="statsAportes"></div>
                        </div>
                        <div id="estadisticasGastos">
                            <h4>üí∏ Gastos por Categor√≠a</h4>
                            <div id="statsGastos"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="export-section">
            <h3>üíæ Gesti√≥n de Datos</h3>
            <p>Exporta tu base de datos o descarga un archivo Excel con toda la informaci√≥n. Tambi√©n puedes importar datos desde Excel y gestionar registros vac√≠os.</p>
            <button class="btn" onclick="exportarExcel()">üìä Descargar Excel</button>
            <button class="btn" onclick="importarExcel()" style="background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);">üìà Importar Excel</button>
            <button class="btn" onclick="exportarBaseDatos()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üíæ Exportar Base de Datos</button>
            <button class="btn" onclick="importarBaseDatos()" style="background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);">üìÇ Importar Base de Datos</button>
            <button class="btn" onclick="limpiarRegistrosVacios()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">üßπ Limpiar Vac√≠os</button>
            <button class="btn btn-danger" onclick="limpiarBaseDatos()">üóëÔ∏è Limpiar Todo</button>
            <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3" style="display: none;" onchange="cargarBaseDatos(event)">
        </div>
    </div>

    <script>
        let db;
        let SQL;

        // Inicializar SQLite
        async function initSQLite() {
            try {
                SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                // Intentar cargar BD existente del localStorage
                const savedDB = localStorage.getItem('fiesta_database');
                if (savedDB) {
                    const data = Uint8Array.from(atob(savedDB), c => c.charCodeAt(0));
                    db = new SQL.Database(data);
                } else {
                    db = new SQL.Database();
                    createTables();
                }

                updateDBStatus('üü¢ BD Conectada', 'db-connected');
                
                // Crear tablas nuevas si no existen (m√©todo m√°s robusto)
                try {
                    // Verificar y crear tabla tareas
                    const checkTareas = db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='tareas'");
                    const tareasExists = checkTareas.step();
                    checkTareas.free();
                    
                    if (!tareasExists) {
                        console.log('Creando tabla tareas...');
                        const createTareasTable = `
                            CREATE TABLE tareas (
                                id INTEGER PRIMARY KEY AUTOINCREMENT,
                                tarea TEXT NOT NULL,
                                categoria TEXT,
                                responsable TEXT,
                                fecha_limite TEXT,
                                prioridad TEXT DEFAULT 'media',
                                estado TEXT DEFAULT 'pendiente',
                                observaciones TEXT,
                                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                            );
                        `;
                        db.run(createTareasTable);
                        console.log('Tabla tareas creada exitosamente');
                    }

                    // Verificar y crear tabla invitados
                    const checkInvitados = db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='invitados'");
                    const invitadosExists = checkInvitados.step();
                    checkInvitados.free();
                    
                    if (!invitadosExists) {
                        console.log('Creando tabla invitados...');
                        const createInvitadosTable = `
                            CREATE TABLE invitados (
                                id INTEGER PRIMARY KEY AUTOINCREMENT,
                                nombre_completo TEXT NOT NULL,
                                relacion TEXT,
                                telefono TEXT,
                                email TEXT,
                                estado TEXT DEFAULT 'pendiente',
                                acompanantes INTEGER DEFAULT 0,
                                necesidades_especiales TEXT,
                                observaciones TEXT,
                                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                            );
                        `;
                        db.run(createInvitadosTable);
                        console.log('Tabla invitados creada exitosamente');
                    }

                } catch (error) {
                    console.error('Error verificando/creando tablas:', error);
                }

                saveDatabase();
                cargarDatos();
            } catch (error) {
                console.error('Error inicializando SQLite:', error);
                updateDBStatus('‚ùå Error BD', '');
            }
        }

        function updateDBStatus(text, className) {
            const statusEl = document.getElementById('dbStatus');
            statusEl.innerHTML = text;
            statusEl.className = `db-status ${className}`;
        }

        function createTables() {
            const createAportesTable = `
                CREATE TABLE aportes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    nombre TEXT NOT NULL,
                    monto_comprometido REAL DEFAULT 0,
                    monto_entregado REAL DEFAULT 0,
                    fecha_aporte TEXT,
                    forma_pago TEXT,
                    observaciones TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                );
            `;

            const createGastosTable = `
                CREATE TABLE gastos (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    categoria TEXT NOT NULL,
                    proveedor TEXT,
                    costo_estimado REAL DEFAULT 0,
                    costo_real REAL DEFAULT 0,
                    fecha_pago TEXT,
                    pagado_por TEXT,
                    observaciones TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                );
            `;

            const createTareasTable = `
                CREATE TABLE tareas (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    tarea TEXT NOT NULL,
                    categoria TEXT,
                    responsable TEXT,
                    fecha_limite TEXT,
                    prioridad TEXT DEFAULT 'media',
                    estado TEXT DEFAULT 'pendiente',
                    observaciones TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                );
            `;

            const createInvitadosTable = `
                CREATE TABLE invitados (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    nombre_completo TEXT NOT NULL,
                    relacion TEXT,
                    telefono TEXT,
                    email TEXT,
                    estado TEXT DEFAULT 'pendiente',
                    acompanantes INTEGER DEFAULT 0,
                    necesidades_especiales TEXT,
                    observaciones TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                );
            `;

            db.run(createAportesTable);
            db.run(createGastosTable);
            db.run(createTareasTable);
            db.run(createInvitadosTable);
            saveDatabase();
        }

        function saveDatabase() {
            if (db) {
                const data = db.export();
                const base64 = btoa(String.fromCharCode(...data));
                localStorage.setItem('fiesta_database', base64);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'resumen') {
                actualizarResumen();
            } else if (tabName === 'invitados') {
                actualizarEstadisticasInvitados();
            } else if (tabName === 'tareas') {
                // Asegurar que se muestren todas las tareas por defecto
                setTimeout(() => {
                    filtrarTareas('todas');
                }, 100);
            }
        }

        function cargarDatos() {
            cargarAportes();
            cargarGastos();
            cargarTareas();
            cargarInvitados();
            actualizarTotales();
        }

        // FUNCIONES PARA TAREAS
        function cargarTareas() {
            const tbody = document.querySelector('#tablaTareas tbody');
            tbody.innerHTML = '';

            try {
                const stmt = db.prepare("SELECT * FROM tareas ORDER BY created_at DESC");
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    
                    const tr = document.createElement('tr');
                    if (row.estado === 'completada') {
                        tr.classList.add('completed-task');
                    }
                    if (row.prioridad === 'alta') {
                        tr.classList.add('high-priority');
                    } else if (row.prioridad === 'media') {
                        tr.classList.add('medium-priority');
                    } else {
                        tr.classList.add('low-priority');
                    }
                    
                    tr.innerHTML = `
                        <td><input type="text" value="${row.tarea || ''}" onchange="actualizarTarea(${row.id}, 'tarea', this.value)"></td>
                        <td>
                            <select onchange="actualizarTarea(${row.id}, 'categoria', this.value)">
                                <option value="">Seleccionar...</option>
                                <option value="planificacion" ${row.categoria === 'planificacion' ? 'selected' : ''}>üìã Planificaci√≥n</option>
                                <option value="decoracion" ${row.categoria === 'decoracion' ? 'selected' : ''}>üéÄ Decoraci√≥n</option>
                                <option value="comida" ${row.categoria === 'comida' ? 'selected' : ''}>üçΩÔ∏è Comida</option>
                                <option value="musica" ${row.categoria === 'musica' ? 'selected' : ''}>üéµ M√∫sica</option>
                                <option value="invitaciones" ${row.categoria === 'invitaciones' ? 'selected' : ''}>üíå Invitaciones</option>
                                <option value="logistica" ${row.categoria === 'logistica' ? 'selected' : ''}>üöõ Log√≠stica</option>
                                <option value="otros" ${row.categoria === 'otros' ? 'selected' : ''}>üì¶ Otros</option>
                            </select>
                        </td>
                        <td><input type="text" value="${row.responsable || ''}" onchange="actualizarTarea(${row.id}, 'responsable', this.value)"></td>
                        <td><input type="date" value="${row.fecha_limite || ''}" onchange="actualizarTarea(${row.id}, 'fecha_limite', this.value)"></td>
                        <td>
                            <select onchange="actualizarTarea(${row.id}, 'prioridad', this.value)">
                                <option value="baja" ${row.prioridad === 'baja' ? 'selected' : ''}>üü¢ Baja</option>
                                <option value="media" ${row.prioridad === 'media' ? 'selected' : ''}>üü° Media</option>
                                <option value="alta" ${row.prioridad === 'alta' ? 'selected' : ''}>üî¥ Alta</option>
                            </select>
                        </td>
                        <td>
                            <select onchange="actualizarTarea(${row.id}, 'estado', this.value)">
                                <option value="pendiente" ${row.estado === 'pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                                <option value="en_progreso" ${row.estado === 'en_progreso' ? 'selected' : ''}>üöß En Progreso</option>
                                <option value="completada" ${row.estado === 'completada' ? 'selected' : ''}>‚úÖ Completada</option>
                            </select>
                        </td>
                        <td><input type="text" value="${row.observaciones || ''}" onchange="actualizarTarea(${row.id}, 'observaciones', this.value)"></td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-small" onclick="eliminarTarea(${row.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                stmt.free();
            } catch (error) {
                console.error('Error cargando tareas:', error);
                // Si hay error, mostrar mensaje en la tabla
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No hay tareas registradas o hay un problema con la base de datos. Intenta agregar una nueva tarea.</td></tr>';
            }
        }

        function agregarNuevaTarea() {
            const stmt = db.prepare("INSERT INTO tareas (tarea) VALUES (?)");
            stmt.run(['Nueva tarea']);
            stmt.free();
            saveDatabase();
            cargarTareas();
        }

        function actualizarTarea(id, campo, valor) {
            const stmt = db.prepare(`UPDATE tareas SET ${campo} = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`);
            stmt.run([valor, id]);
            stmt.free();
            saveDatabase();
            
            if (campo === 'estado' || campo === 'prioridad') {
                cargarTareas();
            }
        }

        function eliminarTarea(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
                const stmt = db.prepare("DELETE FROM tareas WHERE id = ?");
                stmt.run([id]);
                stmt.free();
                saveDatabase();
                cargarTareas();
            }
        }

        function filtrarTareas(filtro) {
            // Remover clase activa de todos los botones
            document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            
            // Agregar clase activa al bot√≥n clickeado
            let btnElement;
            if (filtro === 'todas') {
                btnElement = document.getElementById('btnTodas');
            } else if (filtro === 'pendientes') {
                btnElement = document.getElementById('btnPendientes');
            } else if (filtro === 'finalizadas') {
                btnElement = document.getElementById('btnFinalizadas');
            }
            
            if (btnElement) {
                btnElement.classList.add('filter-active');
            }
            
            const tbody = document.querySelector('#tablaTareas tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const estadoSelect = row.querySelector('select[onchange*="estado"]');
                const estado = estadoSelect ? estadoSelect.value : '';
                
                if (filtro === 'todas') {
                    row.style.display = '';
                } else if (filtro === 'pendientes') {
                    row.style.display = (estado === 'pendiente' || estado === 'en_progreso') ? '' : 'none';
                } else if (filtro === 'finalizadas') {
                    row.style.display = estado === 'completada' ? '' : 'none';
                }
            });
        }

        // FUNCIONES PARA INVITADOS
        function cargarInvitados() {
            const tbody = document.querySelector('#tablaInvitados tbody');
            tbody.innerHTML = '';

            try {
                const stmt = db.prepare("SELECT * FROM invitados ORDER BY created_at DESC");
                while (stmt.step()) {
                    const row = stmt.getAsObject();
                    
                    const tr = document.createElement('tr');
                    if (row.estado === 'confirmado') {
                        tr.classList.add('confirmed');
                    } else if (row.estado === 'no_asiste') {
                        tr.classList.add('declined');
                    }
                    
                    tr.innerHTML = `
                        <td><input type="text" value="${row.nombre_completo || ''}" onchange="actualizarInvitado(${row.id}, 'nombre_completo', this.value)"></td>
                        <td>
                            <select onchange="actualizarInvitado(${row.id}, 'relacion', this.value)">
                                <option value="">Seleccionar...</option>
                                <option value="familia" ${row.relacion === 'familia' ? 'selected' : ''}>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</option>
                                <option value="amigos" ${row.relacion === 'amigos' ? 'selected' : ''}>üë• Amigos</option>
                                <option value="trabajo" ${row.relacion === 'trabajo' ? 'selected' : ''}>üíº Trabajo</option>
                                <option value="vecinos" ${row.relacion === 'vecinos' ? 'selected' : ''}>üèòÔ∏è Vecinos</option>
                                <option value="otros" ${row.relacion === 'otros' ? 'selected' : ''}>üë§ Otros</option>
                            </select>
                        </td>
                        <td><input type="tel" value="${row.telefono || ''}" onchange="actualizarInvitado(${row.id}, 'telefono', this.value)"></td>
                        <td><input type="email" value="${row.email || ''}" onchange="actualizarInvitado(${row.id}, 'email', this.value)"></td>
                        <td>
                            <select onchange="actualizarInvitado(${row.id}, 'estado', this.value)">
                                <option value="pendiente" ${row.estado === 'pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                                <option value="confirmado" ${row.estado === 'confirmado' ? 'selected' : ''}>‚úÖ Confirmado</option>
                                <option value="no_asiste" ${row.estado === 'no_asiste' ? 'selected' : ''}>‚ùå No Asiste</option>
                            </select>
                        </td>
                        <td><input type="number" min="0" value="${row.acompanantes || 0}" onchange="actualizarInvitado(${row.id}, 'acompanantes', this.value)"></td>
                        <td><input type="text" value="${row.necesidades_especiales || ''}" onchange="actualizarInvitado(${row.id}, 'necesidades_especiales', this.value)" placeholder="Alergias, dietas especiales, etc."></td>
                        <td><input type="text" value="${row.observaciones || ''}" onchange="actualizarInvitado(${row.id}, 'observaciones', this.value)"></td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-small" onclick="eliminarInvitado(${row.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                stmt.free();
            } catch (error) {
                console.error('Error cargando invitados:', error);
                // Si hay error, mostrar mensaje en la tabla
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No hay invitados registrados o hay un problema con la base de datos. Intenta agregar un nuevo invitado.</td></tr>';
            }
        }

        function agregarNuevoInvitado() {
            const stmt = db.prepare("INSERT INTO invitados (nombre_completo) VALUES (?)");
            stmt.run(['Nuevo invitado']);
            stmt.free();
            saveDatabase();
            cargarInvitados();
            actualizarEstadisticasInvitados();
        }

        function actualizarInvitado(id, campo, valor) {
            const stmt = db.prepare(`UPDATE invitados SET ${campo} = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`);
            stmt.run([valor, id]);
            stmt.free();
            saveDatabase();
            
            if (campo === 'estado') {
                cargarInvitados();
                actualizarEstadisticasInvitados();
            }
        }

        function eliminarInvitado(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este invitado?')) {
                const stmt = db.prepare("DELETE FROM invitados WHERE id = ?");
                stmt.run([id]);
                stmt.free();
                saveDatabase();
                cargarInvitados();
                actualizarEstadisticasInvitados();
            }
        }

        function actualizarEstadisticasInvitados() {
            const stmt = db.prepare(`
                SELECT 
                    COUNT(*) as total,
                    COUNT(CASE WHEN estado = 'confirmado' THEN 1 END) as confirmados,
                    COUNT(CASE WHEN estado = 'pendiente' THEN 1 END) as pendientes,
                    COUNT(CASE WHEN estado = 'no_asiste' THEN 1 END) as no_asisten,
                    SUM(CASE WHEN estado = 'confirmado' THEN acompanantes + 1 ELSE 0 END) as total_asistentes
                FROM invitados WHERE nombre_completo != ''
            `);
            stmt.step();
            const stats = stmt.getAsObject();
            stmt.free();

            document.getElementById('totalInvitados').textContent = stats.total || 0;
            document.getElementById('totalConfirmados').textContent = stats.confirmados || 0;
            document.getElementById('totalPendientes').textContent = stats.pendientes || 0;
            document.getElementById('totalNoAsisten').textContent = stats.no_asisten || 0;
        }

        function cargarAportes() {
            const tbody = document.querySelector('#tablaAportes tbody');
            tbody.innerHTML = '';

            const stmt = db.prepare("SELECT * FROM aportes ORDER BY created_at DESC");
            while (stmt.step()) {
                const row = stmt.getAsObject();
                const saldo = (row.monto_comprometido || 0) - (row.monto_entregado || 0);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row.nombre || ''}" onchange="actualizarAporte(${row.id}, 'nombre', this.value)"></td>
                    <td><input type="number" step="0.01" value="${row.monto_comprometido || 0}" onchange="actualizarAporte(${row.id}, 'monto_comprometido', this.value)"></td>
                    <td><input type="number" step="0.01" value="${row.monto_entregado || 0}" onchange="actualizarAporte(${row.id}, 'monto_entregado', this.value)"></td>
                    <td><input type="date" value="${row.fecha_aporte || ''}" onchange="actualizarAporte(${row.id}, 'fecha_aporte', this.value)"></td>
                    <td>
                        <select onchange="actualizarAporte(${row.id}, 'forma_pago', this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="efectivo" ${row.forma_pago === 'efectivo' ? 'selected' : ''}>Efectivo</option>
                            <option value="transferencia" ${row.forma_pago === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                            <option value="tarjeta" ${row.forma_pago === 'tarjeta' ? 'selected' : ''}>Tarjeta</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.observaciones || ''}" onchange="actualizarAporte(${row.id}, 'observaciones', this.value)"></td>
                    <td class="currency ${saldo > 0 ? 'pending' : ''}">‚Ç°${saldo.toFixed(2)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarAporte(${row.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            stmt.free();
        }

        function cargarGastos() {
            const tbody = document.querySelector('#tablaGastos tbody');
            tbody.innerHTML = '';

            const stmt = db.prepare("SELECT * FROM gastos ORDER BY created_at DESC");
            while (stmt.step()) {
                const row = stmt.getAsObject();
                const diferencia = (row.costo_estimado || 0) - (row.costo_real || 0);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="actualizarGasto(${row.id}, 'categoria', this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="banquete" ${row.categoria === 'banquete' ? 'selected' : ''}>üçΩÔ∏è Banquete</option>
                            <option value="musica" ${row.categoria === 'musica' ? 'selected' : ''}>üéµ M√∫sica</option>
                            <option value="decoracion" ${row.categoria === 'decoracion' ? 'selected' : ''}>üéÄ Decoraci√≥n</option>
                            <option value="fotografia" ${row.categoria === 'fotografia' ? 'selected' : ''}>üì∏ Fotograf√≠a</option>
                            <option value="otros" ${row.categoria === 'otros' ? 'selected' : ''}>üì¶ Otros</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.proveedor || ''}" onchange="actualizarGasto(${row.id}, 'proveedor', this.value)"></td>
                    <td><input type="number" step="0.01" value="${row.costo_estimado || 0}" onchange="actualizarGasto(${row.id}, 'costo_estimado', this.value)"></td>
                    <td><input type="number" step="0.01" value="${row.costo_real || 0}" onchange="actualizarGasto(${row.id}, 'costo_real', this.value)"></td>
                    <td class="currency ${diferencia > 0 ? 'positive-diff' : diferencia < 0 ? 'negative-diff' : ''}">‚Ç°${diferencia.toFixed(2)}</td>
                    <td><input type="date" value="${row.fecha_pago || ''}" onchange="actualizarGasto(${row.id}, 'fecha_pago', this.value)"></td>
                    <td><input type="text" value="${row.pagado_por || ''}" onchange="actualizarGasto(${row.id}, 'pagado_por', this.value)"></td>
                    <td><input type="text" value="${row.observaciones || ''}" onchange="actualizarGasto(${row.id}, 'observaciones', this.value)"></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarGasto(${row.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            stmt.free();
        }

        function agregarNuevoAporte() {
            const stmt = db.prepare("INSERT INTO aportes (nombre) VALUES (?)");
            stmt.run(['Nuevo familiar']);
            stmt.free();
            saveDatabase();
            cargarAportes();
            actualizarTotales();
        }

        function agregarNuevoGasto() {
            const stmt = db.prepare("INSERT INTO gastos (categoria) VALUES (?)");
            stmt.run(['']);
            stmt.free();
            saveDatabase();
            cargarGastos();
            actualizarTotales();
        }

        function actualizarAporte(id, campo, valor) {
            const stmt = db.prepare(`UPDATE aportes SET ${campo} = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`);
            stmt.run([valor, id]);
            stmt.free();
            saveDatabase();
            
            // Recalcular saldo si es necesario
            if (campo === 'monto_comprometido' || campo === 'monto_entregado') {
                cargarAportes();
            }
            actualizarTotales();
        }

        function actualizarGasto(id, campo, valor) {
            const stmt = db.prepare(`UPDATE gastos SET ${campo} = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`);
            stmt.run([valor, id]);
            stmt.free();
            saveDatabase();
            
            // Recalcular diferencia si es necesario
            if (campo === 'costo_estimado' || campo === 'costo_real') {
                cargarGastos();
            }
            actualizarTotales();
        }

        function eliminarAporte(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este aporte?')) {
                const stmt = db.prepare("DELETE FROM aportes WHERE id = ?");
                stmt.run([id]);
                stmt.free();
                saveDatabase();
                cargarAportes();
                actualizarTotales();
            }
        }

        function eliminarGasto(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este gasto?')) {
                const stmt = db.prepare("DELETE FROM gastos WHERE id = ?");
                stmt.run([id]);
                stmt.free();
                saveDatabase();
                cargarGastos();
                actualizarTotales();
            }
        }

        function actualizarTotales() {
            // Totales de gastos
            const gastosStmt = db.prepare("SELECT SUM(costo_estimado) as total_estimado, SUM(costo_real) as total_real FROM gastos");
            gastosStmt.step();
            const gastosData = gastosStmt.getAsObject();
            gastosStmt.free();

            const totalEstimado = gastosData.total_estimado || 0;
            const totalReal = gastosData.total_real || 0;

            document.getElementById('totalEstimado').textContent = `‚Ç°${totalEstimado.toFixed(2)}`;
            document.getElementById('totalReal').textContent = `‚Ç°${totalReal.toFixed(2)}`;
            document.getElementById('totalDiferencia').textContent = `‚Ç°${(totalEstimado - totalReal).toFixed(2)}`;
        }

        function actualizarResumen() {
            // Aportes
            const aportesStmt = db.prepare("SELECT SUM(monto_comprometido) as total_comprometido, SUM(monto_entregado) as total_recibido FROM aportes");
            aportesStmt.step();
            const aportesData = aportesStmt.getAsObject();
            aportesStmt.free();

            // Gastos
            const gastosStmt = db.prepare("SELECT SUM(costo_estimado) as total_estimado, SUM(costo_real) as total_real FROM gastos");
            gastosStmt.step();
            const gastosData = gastosStmt.getAsObject();
            gastosStmt.free();

            const totalComprometido = aportesData.total_comprometido || 0;
            const totalRecibido = aportesData.total_recibido || 0;
            const totalEstimado = gastosData.total_estimado || 0;
            const totalReal = gastosData.total_real || 0;
            const balance = totalRecibido - totalReal;

            document.getElementById('totalComprometido').textContent = `‚Ç°${totalComprometido.toFixed(2)}`;
            document.getElementById('totalRecibido').textContent = `‚Ç°${totalRecibido.toFixed(2)}`;
            document.getElementById('resumenEstimado').textContent = `‚Ç°${totalEstimado.toFixed(2)}`;
            document.getElementById('resumenReal').textContent = `‚Ç°${totalReal.toFixed(2)}`;
            
            const balanceElement = document.getElementById('balanceFinal');
            balanceElement.textContent = `‚Ç°${balance.toFixed(2)}`;
            
            if (balance < 0) {
                balanceElement.style.color = '#ff4757';
            } else if (balance > 0) {
                balanceElement.style.color = '#2ed573';
            } else {
                balanceElement.style.color = 'white';
            }
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas();
        }

        function actualizarEstadisticas() {
            // Estad√≠sticas de aportes
            const aportesStatsStmt = db.prepare(`
                SELECT 
                    COUNT(*) as total_personas,
                    COUNT(CASE WHEN monto_entregado >= monto_comprometido THEN 1 END) as personas_al_dia,
                    COUNT(CASE WHEN monto_entregado < monto_comprometido THEN 1 END) as personas_pendientes
                FROM aportes WHERE nombre != ''
            `);
            aportesStatsStmt.step();
            const aportesStats = aportesStatsStmt.getAsObject();
            aportesStatsStmt.free();

            document.getElementById('statsAportes').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p><strong>Total Familiares:</strong> ${aportesStats.total_personas}</p>
                    <p><strong>Al d√≠a:</strong> ${aportesStats.personas_al_dia}</p>
                    <p><strong>Pendientes:</strong> ${aportesStats.personas_pendientes}</p>
                </div>
            `;

            // Estad√≠sticas de gastos
            const gastosStatsStmt = db.prepare(`
                SELECT 
                    categoria,
                    SUM(costo_real) as total_categoria
                FROM gastos 
                WHERE categoria != '' AND costo_real > 0
                GROUP BY categoria
                ORDER BY total_categoria DESC
            `);
            
            let gastosHTML = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
            while (gastosStatsStmt.step()) {
                const row = gastosStatsStmt.getAsObject();
                const emoji = {
                    'banquete': 'üçΩÔ∏è',
                    'musica': 'üéµ',
                    'decoracion': 'üéÄ',
                    'fotografia': 'üì∏',
                    'otros': 'üì¶'
                };
                gastosHTML += `<p><strong>${emoji[row.categoria] || 'üì¶'} ${row.categoria}:</strong> ‚Ç°${(row.total_categoria || 0).toFixed(2)}</p>`;
            }
            gastosStatsStmt.free();
            gastosHTML += '</div>';
            
            document.getElementById('statsGastos').innerHTML = gastosHTML;
        }

        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            
            // Hoja 1: Aportes
            const aportesData = [['ID', 'Nombre del Integrante', 'Monto Comprometido', 'Monto Entregado', 'Fecha de Aporte', 'Forma de Pago', 'Observaciones', 'Saldo Pendiente']];
            
            const aportesStmt = db.prepare("SELECT * FROM aportes ORDER BY id");
            while (aportesStmt.step()) {
                const row = aportesStmt.getAsObject();
                const saldo = (row.monto_comprometido || 0) - (row.monto_entregado || 0);
                aportesData.push([
                    row.id,
                    row.nombre || '',
                    row.monto_comprometido || 0,
                    row.monto_entregado || 0,
                    row.fecha_aporte || '',
                    row.forma_pago || '',
                    row.observaciones || '',
                    saldo
                ]);
            }
            aportesStmt.free();
            
            const ws1 = XLSX.utils.aoa_to_sheet(aportesData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Aportes de la Familia');
            
            // Hoja 2: Gastos
            const gastosData = [['ID', 'Categor√≠a', 'Proveedor', 'Costo Estimado', 'Costo Real', 'Diferencia', 'Fecha de Pago', 'Pagado Por', 'Observaciones']];
            
            const gastosStmt = db.prepare("SELECT * FROM gastos ORDER BY id");
            while (gastosStmt.step()) {
                const row = gastosStmt.getAsObject();
                const diferencia = (row.costo_estimado || 0) - (row.costo_real || 0);
                gastosData.push([
                    row.id,
                    row.categoria || '',
                    row.proveedor || '',
                    row.costo_estimado || 0,
                    row.costo_real || 0,
                    diferencia,
                    row.fecha_pago || '',
                    row.pagado_por || '',
                    row.observaciones || ''
                ]);
            }
            gastosStmt.free();
            
            const ws2 = XLSX.utils.aoa_to_sheet(gastosData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Gastos de la Fiesta');
            
            // Hoja 3: Resumen
            const aportesResumenStmt = db.prepare("SELECT SUM(monto_comprometido) as total_comprometido, SUM(monto_entregado) as total_recibido FROM aportes");
            aportesResumenStmt.step();
            const aportesResumen = aportesResumenStmt.getAsObject();
            aportesResumenStmt.free();

            const gastosResumenStmt = db.prepare("SELECT SUM(costo_estimado) as total_estimado, SUM(costo_real) as total_real FROM gastos");
            gastosResumenStmt.step();
            const gastosResumen = gastosResumenStmt.getAsObject();
            gastosResumenStmt.free();

            const resumenData = [];
            resumenData.push(['Concepto', 'Monto']);
            resumenData.push(['Total Aportes Comprometidos', aportesResumen.total_comprometido || 0]);
            resumenData.push(['Total Aportes Recibidos', aportesResumen.total_recibido || 0]);
            resumenData.push(['Total Gastos Estimados', gastosResumen.total_estimado || 0]);
            resumenData.push(['Total Gastos Reales', gastosResumen.total_real || 0]);
            resumenData.push(['Balance Final', (aportesResumen.total_recibido || 0) - (gastosResumen.total_real || 0)]);
            
            const ws3 = XLSX.utils.aoa_to_sheet(resumenData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Resumen General');
            
            // Hoja 4: Tareas
            const tareasData = [['ID', 'Tarea', 'Categor√≠a', 'Responsable', 'Fecha L√≠mite', 'Prioridad', 'Estado', 'Observaciones']];
            
            const tareasStmt = db.prepare("SELECT * FROM tareas ORDER BY id");
            while (tareasStmt.step()) {
                const row = tareasStmt.getAsObject();
                tareasData.push([
                    row.id,
                    row.tarea || '',
                    row.categoria || '',
                    row.responsable || '',
                    row.fecha_limite || '',
                    row.prioridad || '',
                    row.estado || '',
                    row.observaciones || ''
                ]);
            }
            tareasStmt.free();
            
            const ws4 = XLSX.utils.aoa_to_sheet(tareasData);
            XLSX.utils.book_append_sheet(wb, ws4, 'Tareas');
            
            // Hoja 5: Invitados
            const invitadosData = [['ID', 'Nombre Completo', 'Relaci√≥n', 'Tel√©fono', 'Email', 'Estado', 'Acompa√±antes', 'Necesidades Especiales', 'Observaciones']];
            
            const invitadosStmt = db.prepare("SELECT * FROM invitados ORDER BY id");
            while (invitadosStmt.step()) {
                const row = invitadosStmt.getAsObject();
                invitadosData.push([
                    row.id,
                    row.nombre_completo || '',
                    row.relacion || '',
                    row.telefono || '',
                    row.email || '',
                    row.estado || '',
                    row.acompanantes || 0,
                    row.necesidades_especiales || '',
                    row.observaciones || ''
                ]);
            }
            invitadosStmt.free();
            
            const ws5 = XLSX.utils.aoa_to_sheet(invitadosData);
            XLSX.utils.book_append_sheet(wb, ws5, 'Invitados');
            
            // Descargar el archivo con fecha
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `fiesta_50_aniversario_${fecha}.xlsx`);
            alert('üìä ¬°Archivo Excel descargado exitosamente! üéâ');
        }

        function exportarBaseDatos() {
            if (!db) {
                alert('Base de datos no disponible');
                return;
            }

            const data = db.export();
            const blob = new Blob([data], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `fiesta_50_aniversario_${new Date().toISOString().split('T')[0]}.db`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('¬°Base de datos exportada exitosamente! üíæ');
        }

        function importarBaseDatos() {
            document.getElementById('fileInput').click();
        }

        function cargarBaseDatos(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const data = new Uint8Array(arrayBuffer);
                    
                    // Crear nueva base de datos con los datos importados
                    db = new SQL.Database(data);
                    saveDatabase();
                    cargarDatos();
                    
                    alert('¬°Base de datos importada exitosamente! üìÇ');
                    updateDBStatus('üü¢ BD Importada', 'db-connected');
                } catch (error) {
                    console.error('Error importando base de datos:', error);
                    alert('Error al importar la base de datos. Verifica que el archivo sea v√°lido.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function limpiarBaseDatos() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar TODOS los datos?\n\nEsta acci√≥n no se puede deshacer.')) {
                if (confirm('üö® CONFIRMACI√ìN FINAL: Se borrar√°n todos los aportes, gastos, tareas e invitados registrados.')) {
                    db.run("DELETE FROM aportes");
                    db.run("DELETE FROM gastos");
                    db.run("DELETE FROM tareas");
                    db.run("DELETE FROM invitados");
                    saveDatabase();
                    cargarDatos();
                    alert('‚úÖ Base de datos limpiada exitosamente');
                }
            }
        }

        // Funci√≥n para importar desde Excel
        function importarExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        let importCount = 0;
                        
                        // Importar Aportes
                        if (workbook.SheetNames.includes('Aportes de la Familia')) {
                            const aportesSheet = workbook.Sheets['Aportes de la Familia'];
                            const aportesData = XLSX.utils.sheet_to_json(aportesSheet, { header: 1 });
                            
                            // Saltar la primera fila (headers)
                            for (let i = 1; i < aportesData.length; i++) {
                                const row = aportesData[i];
                                if (row[1] && row[1].toString().trim() !== '') { // Si tiene nombre
                                    const stmt = db.prepare(`
                                        INSERT INTO aportes (nombre, monto_comprometido, monto_entregado, fecha_aporte, forma_pago, observaciones)
                                        VALUES (?, ?, ?, ?, ?, ?)
                                    `);
                                    stmt.run([
                                        row[1]?.toString() || '',
                                        parseFloat(row[2]) || 0,
                                        parseFloat(row[3]) || 0,
                                        row[4]?.toString() || '',
                                        row[5]?.toString() || '',
                                        row[6]?.toString() || ''
                                    ]);
                                    stmt.free();
                                    importCount++;
                                }
                            }
                        }
                        
                        // Importar Gastos
                        if (workbook.SheetNames.includes('Gastos de la Fiesta')) {
                            const gastosSheet = workbook.Sheets['Gastos de la Fiesta'];
                            const gastosData = XLSX.utils.sheet_to_json(gastosSheet, { header: 1 });
                            
                            for (let i = 1; i < gastosData.length; i++) {
                                const row = gastosData[i];
                                if (row[1] && row[1].toString().trim() !== '') { // Si tiene categor√≠a
                                    const stmt = db.prepare(`
                                        INSERT INTO gastos (categoria, proveedor, costo_estimado, costo_real, fecha_pago, pagado_por, observaciones)
                                        VALUES (?, ?, ?, ?, ?, ?, ?)
                                    `);
                                    stmt.run([
                                        row[1]?.toString() || '',
                                        row[2]?.toString() || '',
                                        parseFloat(row[3]) || 0,
                                        parseFloat(row[4]) || 0,
                                        row[6]?.toString() || '',
                                        row[7]?.toString() || '',
                                        row[8]?.toString() || ''
                                    ]);
                                    stmt.free();
                                    importCount++;
                                }
                            }
                        }
                        
                        // Importar Tareas
                        if (workbook.SheetNames.includes('Tareas')) {
                            const tareasSheet = workbook.Sheets['Tareas'];
                            const tareasData = XLSX.utils.sheet_to_json(tareasSheet, { header: 1 });
                            
                            for (let i = 1; i < tareasData.length; i++) {
                                const row = tareasData[i];
                                if (row[1] && row[1].toString().trim() !== '') { // Si tiene tarea
                                    const stmt = db.prepare(`
                                        INSERT INTO tareas (tarea, categoria, responsable, fecha_limite, prioridad, estado, observaciones)
                                        VALUES (?, ?, ?, ?, ?, ?, ?)
                                    `);
                                    stmt.run([
                                        row[1]?.toString() || '',
                                        row[2]?.toString() || '',
                                        row[3]?.toString() || '',
                                        row[4]?.toString() || '',
                                        row[5]?.toString() || 'media',
                                        row[6]?.toString() || 'pendiente',
                                        row[7]?.toString() || ''
                                    ]);
                                    stmt.free();
                                    importCount++;
                                }
                            }
                        }
                        
                        // Importar Invitados
                        if (workbook.SheetNames.includes('Invitados')) {
                            const invitadosSheet = workbook.Sheets['Invitados'];
                            const invitadosData = XLSX.utils.sheet_to_json(invitadosSheet, { header: 1 });
                            
                            for (let i = 1; i < invitadosData.length; i++) {
                                const row = invitadosData[i];
                                if (row[1] && row[1].toString().trim() !== '') { // Si tiene nombre
                                    const stmt = db.prepare(`
                                        INSERT INTO invitados (nombre_completo, relacion, telefono, email, estado, acompanantes, necesidades_especiales, observaciones)
                                        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                                    `);
                                    stmt.run([
                                        row[1]?.toString() || '',
                                        row[2]?.toString() || '',
                                        row[3]?.toString() || '',
                                        row[4]?.toString() || '',
                                        row[5]?.toString() || 'pendiente',
                                        parseInt(row[6]) || 0,
                                        row[7]?.toString() || '',
                                        row[8]?.toString() || ''
                                    ]);
                                    stmt.free();
                                    importCount++;
                                }
                            }
                        }
                        
                        saveDatabase();
                        cargarDatos();
                        alert(`üìà Archivo Excel importado exitosamente!\n${importCount} registros importados.`);
                        
                    } catch (error) {
                        console.error('Error importando Excel:', error);
                        alert('‚ùå Error al importar el archivo Excel.\nVerifica que el formato sea correcto y que sea un archivo Excel v√°lido.');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        // Inicializar la aplicaci√≥n cuando se carga la p√°gina
        window.addEventListener('load', async function() {
            await initSQLite();
            // Inicializar filtros por defecto
            setTimeout(() => {
                if (document.getElementById('btnTodas')) {
                    filtrarTareas('todas');
                }
            }, 500);
        });

        // Funci√≥n para limpiar registros vac√≠os
        function limpiarRegistrosVacios() {
            if (confirm('¬øDeseas eliminar los registros que no tienen informaci√≥n relevante?')) {
                try {
                    // Limpiar aportes sin nombre
                    db.run("DELETE FROM aportes WHERE nombre = '' OR nombre IS NULL");
                    
                    // Limpiar gastos sin categor√≠a
                    db.run("DELETE FROM gastos WHERE categoria = '' OR categoria IS NULL");
                    
                    // Limpiar tareas sin descripci√≥n
                    db.run("DELETE FROM tareas WHERE tarea = '' OR tarea IS NULL");
                    
                    // Limpiar invitados sin nombre
                    db.run("DELETE FROM invitados WHERE nombre_completo = '' OR nombre_completo IS NULL");
                    
                    saveDatabase();
                    cargarDatos();
                    alert('‚úÖ Registros vac√≠os eliminados exitosamente');
                } catch (error) {
                    console.error('Error limpiando registros:', error);
                    alert('‚ùå Error al limpiar registros vac√≠os');
                }
            }
        }
    </script>
</body>
</html>