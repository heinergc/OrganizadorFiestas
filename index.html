<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrganizadorFiestas - 50 Aniversario (Cloud)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        
        // Configuraci√≥n de Firebase (reemplaza con tu configuraci√≥n)
        const firebaseConfig = {
            apiKey: "AIzaSyDZNbANkDPao0nucej2kW2u3VtltfGoYck",
            authDomain: "organizadorfiestas-b7190.firebaseapp.com",
            projectId: "organizadorfiestas-b7190",
            storageBucket: "organizadorfiestas-b7190.firebasestorage.app",
            messagingSenderId: "390736807585",
            appId: "1:390736807585:web:0bcfc21202acc8cc7e92e0",
            measurementId: "G-ZCNPZPETW9"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Hacer disponible globalmente
        window.firebaseDB = db;
        window.firebaseFunctions = {
            collection,
            addDoc,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            query,
            orderBy
        };
        
        // Inicializar la aplicaci√≥n cuando Firebase est√© listo
        window.addEventListener('load', function() {
            initApp();
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            text-align: center;
            padding: 30px;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .db-status {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .db-connected {
            background: rgba(46, 213, 115, 0.3);
        }
        
        .db-error {
            background: rgba(255, 71, 87, 0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #19547b;
            border-bottom-color: #19547b;
        }
        
        .tab-content {
            padding: 30px;
            min-height: 600px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #19547b 0%, #ffd89b 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #19547b;
            box-shadow: 0 0 0 2px rgba(25, 84, 123, 0.2);
        }
        
        .currency {
            text-align: right;
            font-weight: 500;
        }
        
        .pending {
            background: #fee;
            color: #c53030;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, #19547b 0%, #ffd89b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px 5px;
            transition: transform 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 60px;
        }
        
        .add-row {
            margin: 20px 0;
            text-align: center;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .cloud-info {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #19547b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .action-buttons {
            display: inline-flex;
            gap: 5px;
            white-space: nowrap;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab {
                min-width: 120px;
                font-size: 14px;
                padding: 12px 15px;
            }
            
            table {
                font-size: 12px;
                min-width: 800px;
            }
            
            .tab-content {
                overflow-x: auto;
                padding: 15px;
            }
        }
        
        /* Estilos para reporte imprimible */
        .reporte-completo {
            display: none;
            background: white;
            padding: 30px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.6;
        }
        
        .reporte-header {
            text-align: center;
            border-bottom: 3px solid #19547b;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .reporte-header h1 {
            color: #19547b;
            font-size: 2.5em;
            margin: 0;
        }
        
        .reporte-header p {
            color: #666;
            font-size: 1.2em;
            margin: 10px 0 0 0;
        }
        
        .reporte-seccion {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        
        .reporte-seccion h2 {
            color: #19547b;
            font-size: 1.8em;
            border-bottom: 2px solid #ffd89b;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .reporte-tabla {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .reporte-tabla th {
            background: #19547b;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
        }
        
        .reporte-tabla td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .reporte-tabla tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .reporte-resumen {
            background: linear-gradient(135deg, #19547b 0%, #ffd89b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .reporte-resumen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .reporte-resumen-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .reporte-resumen-item h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        
        .reporte-resumen-item .valor {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .reporte-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            color: #666;
        }
        
        /* Estilos para impresi√≥n */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .reporte-completo, .reporte-completo * {
                visibility: visible;
            }
            
            .reporte-completo {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
                padding: 20px;
            }
            
            .reporte-seccion {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }
            
            .reporte-tabla {
                font-size: 10px;
            }
            
            .reporte-tabla th {
                background: #19547b !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .reporte-resumen {
                background: #19547b !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            @page {
                margin: 1cm;
                size: A4;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="db-status" id="dbStatus">
                <span class="loading"></span> Conectando a la nube...
            </div>
            <button onclick="mostrarInfoCloud()" style="position: absolute; top: 15px; left: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(10px);">
                ‚òÅÔ∏è Info
            </button>
            <h1>üéâ Organizador de Fiesta</h1>
            <p>50 Aniversario de Bodas - Versi√≥n Cloud</p>
        </div>
        
        <div class="cloud-info">
            <strong>‚òÅÔ∏è Base de Datos en la Nube</strong><br>
            Tus datos se sincronizan autom√°ticamente entre todos tus dispositivos y navegadores.
            Accede desde cualquier lugar y mant√©n todo actualizado en tiempo real.
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('aportes')">üí∞ Aportes de la Familia</button>
            <button class="tab" onclick="showTab('gastos')">üí∏ Gastos de la Fiesta</button>
            <button class="tab" onclick="showTab('tareas')">üìù Tareas</button>
            <button class="tab" onclick="showTab('invitados')">üë• Invitados</button>
            <button class="tab" onclick="showTab('resumen')">üìä Resumen General</button>
        </div>
        
        <div class="tab-content">
            <!-- HOJA 1: APORTES DE LA FAMILIA -->
            <div id="aportes" class="tab-pane active">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Registra los aportes de cada familiar. Los datos se guardan autom√°ticamente en la nube y se sincronizan entre todos tus dispositivos en tiempo real.
                </div>
                
                <table id="tablaAportes">
                    <thead>
                        <tr>
                            <th>Nombre del Integrante</th>
                            <th>Monto Comprometido</th>
                            <th>Monto Entregado</th>
                            <th>Fecha de Aporte</th>
                            <th>Forma de Pago</th>
                            <th>Observaciones</th>
                            <th>Saldo Pendiente</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde Firebase -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevoAporte()">‚ûï Agregar Familiar</button>
                </div>
            </div>
            
            <!-- HOJA 2: GASTOS DE LA FIESTA -->
            <div id="gastos" class="tab-pane">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Registra todos los gastos de la fiesta por categor√≠as. Los datos se almacenan autom√°ticamente en la nube.
                </div>
                
                <table id="tablaGastos">
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Proveedor</th>
                            <th>Costo Estimado</th>
                            <th>Costo Real</th>
                            <th>Diferencia</th>
                            <th>Fecha de Pago</th>
                            <th>Pagado Por</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde Firebase -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevoGasto()">‚ûï Agregar Gasto</button>
                </div>
            </div>
            
            <!-- HOJA 3: TAREAS -->
            <div id="tareas" class="tab-pane">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Organiza todas las tareas necesarias para la fiesta. Sincronizaci√≥n autom√°tica en tiempo real.
                </div>
                
                <table id="tablaTareas">
                    <thead>
                        <tr>
                            <th>Tarea</th>
                            <th>Categor√≠a</th>
                            <th>Responsable</th>
                            <th>Fecha L√≠mite</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde Firebase -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevaTarea()">‚ûï Agregar Tarea</button>
                </div>
            </div>
            
            <!-- HOJA 4: INVITADOS -->
            <div id="invitados" class="tab-pane">
                <div class="instructions">
                    <strong>üí° Instrucciones:</strong> Gestiona la lista de invitados con sincronizaci√≥n autom√°tica en todos tus dispositivos.
                </div>
                
                <table id="tablaInvitados">
                    <thead>
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Relaci√≥n</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Estado</th>
                            <th>Acompa√±antes</th>
                            <th>Necesidades Especiales</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n desde Firebase -->
                    </tbody>
                </table>
                
                <div class="add-row">
                    <button class="btn" onclick="agregarNuevoInvitado()">‚ûï Agregar Invitado</button>
                </div>
            </div>
            
            <!-- HOJA 5: RESUMEN GENERAL -->
            <div id="resumen" class="tab-pane">
                <div class="instructions">
                    <strong>üìä Resumen financiero actualizado en tiempo real desde la nube.</strong>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="generarReporteCompleto()" style="background: #e91e63; margin-right: 10px;">üìã Generar Reporte Completo</button>
                    <button class="btn" onclick="imprimirReporte()" style="background: #9c27b0;">üñ®Ô∏è Imprimir PDF</button>
                </div>
                
                <div id="resumenContent">
                    <!-- Se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
        
        <div style="text-align: center; padding: 20px; background: #f8f9fa; margin: 20px 0; border-radius: 8px;">
            <h3>üìä Importar/Exportar Datos</h3>
            
            <!-- Importar Excel -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                <h4>üì• Importar desde Excel</h4>
                <p>Sube un archivo Excel con datos de la fiesta</p>
                <div style="margin: 10px 0;">
                    <button class="btn" onclick="mostrarAyudaImportacion()" style="background: #2196F3; margin-right: 10px;">‚ùì Ver Formato</button>
                    <button class="btn" onclick="descargarPlantilla()" style="background: #FF9800;">üìÑ Descargar Plantilla</button>
                </div>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="margin: 10px; padding: 10px;">
                <button class="btn" onclick="importarExcel()">üì• Cargar Excel a la Nube</button>
                <div id="importStatus" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
            
            <!-- Exportar Excel -->
            <div style="padding: 15px; background: #f3e5f5; border-radius: 8px;">
                <h4>üì§ Exportar a Excel</h4>
                <p>Descarga todos tus datos desde la nube en formato Excel</p>
                <button class="btn" onclick="exportarExcel()">üìä Descargar Excel</button>
            </div>
        </div>
    </div>

    <!-- Reporte Completo para Imprimir -->
    <div id="reporteCompleto" class="reporte-completo">
        <!-- Se generar√° din√°micamente -->
    </div>

    <script>
        let aportes = [];
        let gastos = [];
        let tareas = [];
        let invitados = [];
        
        // Inicializar la aplicaci√≥n
        async function initApp() {
            try {
                updateDBStatus('üü¢ Conectado a la nube', 'db-connected');
                await cargarDatos();
            } catch (error) {
                console.error('Error inicializando:', error);
                updateDBStatus('‚ùå Error de conexi√≥n', 'db-error');
                mostrarModoOffline();
            }
        }
        
        function updateDBStatus(text, className) {
            const statusEl = document.getElementById('dbStatus');
            statusEl.innerHTML = text;
            statusEl.className = `db-status ${className}`;
        }
        
        function mostrarModoOffline() {
            alert('‚ö†Ô∏è No se pudo conectar a la base de datos en la nube.\n\nPor favor:\n1. Verifica tu conexi√≥n a internet\n2. Configura Firebase correctamente\n3. Actualiza la p√°gina');
        }
        
        function mostrarInfoCloud() {
            alert(`‚òÅÔ∏è BASE DE DATOS EN LA NUBE

‚úÖ VENTAJAS:
‚Ä¢ Acceso desde cualquier dispositivo
‚Ä¢ Sincronizaci√≥n autom√°tica en tiempo real
‚Ä¢ Sin p√©rdida de datos al cambiar navegador
‚Ä¢ Respaldos autom√°ticos en la nube
‚Ä¢ Colaboraci√≥n familiar en tiempo real

üîß CONFIGURACI√ìN REQUERIDA:
Para que funcione necesitas configurar Firebase:
1. Crear proyecto en Firebase
2. Habilitar Firestore
3. Configurar las credenciales en el c√≥digo

üì± UNA VEZ CONFIGURADO:
Podr√°s acceder desde cualquier lugar y dispositivo
con tus datos siempre sincronizados.`);
        }
        
        // Funciones para manejar datos
        async function cargarDatos() {
            if (!window.firebaseDB) {
                console.error('Firebase no est√° configurado');
                return;
            }
            
            try {
                // Cargar aportes
                const aportesSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDB, 'aportes')
                );
                aportes = aportesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Cargar gastos
                const gastosSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDB, 'gastos')
                );
                gastos = gastosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Cargar tareas
                const tareasSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDB, 'tareas')
                );
                tareas = tareasSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Cargar invitados
                const invitadosSnapshot = await window.firebaseFunctions.getDocs(
                    window.firebaseFunctions.collection(window.firebaseDB, 'invitados')
                );
                invitados = invitadosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Actualizar todas las tablas
                actualizarTablaAportes();
                actualizarTablaGastos();
                actualizarTablaTareas();
                actualizarTablaInvitados();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                updateDBStatus('‚ùå Error cargando datos', 'db-error');
            }
        }
        
        // Funciones para actualizar tablas
        function actualizarTablaAportes() {
            const tbody = document.querySelector('#tablaAportes tbody');
            tbody.innerHTML = '';
            
            aportes.forEach(aporte => {
                const saldo = (aporte.monto_comprometido || 0) - (aporte.monto_entregado || 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${aporte.nombre || ''}" onchange="actualizarAporte('${aporte.id}', 'nombre', this.value)"></td>
                    <td><input type="number" step="0.01" value="${aporte.monto_comprometido || 0}" onchange="actualizarAporte('${aporte.id}', 'monto_comprometido', this.value)"></td>
                    <td><input type="number" step="0.01" value="${aporte.monto_entregado || 0}" onchange="actualizarAporte('${aporte.id}', 'monto_entregado', this.value)"></td>
                    <td><input type="date" value="${aporte.fecha_aporte || ''}" onchange="actualizarAporte('${aporte.id}', 'fecha_aporte', this.value)"></td>
                    <td>
                        <select onchange="actualizarAporte('${aporte.id}', 'forma_pago', this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="efectivo" ${aporte.forma_pago === 'efectivo' ? 'selected' : ''}>Efectivo</option>
                            <option value="transferencia" ${aporte.forma_pago === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                            <option value="tarjeta" ${aporte.forma_pago === 'tarjeta' ? 'selected' : ''}>Tarjeta</option>
                        </select>
                    </td>
                    <td><input type="text" value="${aporte.observaciones || ''}" onchange="actualizarAporte('${aporte.id}', 'observaciones', this.value)"></td>
                    <td class="currency ${saldo > 0 ? 'pending' : ''}">‚Ç°${saldo.toFixed(2)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarAporte('${aporte.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function actualizarTablaGastos() {
            const tbody = document.querySelector('#tablaGastos tbody');
            tbody.innerHTML = '';
            
            gastos.forEach(gasto => {
                const diferencia = (gasto.costo_estimado || 0) - (gasto.costo_real || 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="actualizarGasto('${gasto.id}', 'categoria', this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="banquete" ${gasto.categoria === 'banquete' ? 'selected' : ''}>üçΩÔ∏è Banquete</option>
                            <option value="musica" ${gasto.categoria === 'musica' ? 'selected' : ''}>üéµ M√∫sica</option>
                            <option value="decoracion" ${gasto.categoria === 'decoracion' ? 'selected' : ''}>üéÄ Decoraci√≥n</option>
                            <option value="fotografia" ${gasto.categoria === 'fotografia' ? 'selected' : ''}>üì∏ Fotograf√≠a</option>
                            <option value="otros" ${gasto.categoria === 'otros' ? 'selected' : ''}>üì¶ Otros</option>
                        </select>
                    </td>
                    <td><input type="text" value="${gasto.proveedor || ''}" onchange="actualizarGasto('${gasto.id}', 'proveedor', this.value)"></td>
                    <td><input type="number" step="0.01" value="${gasto.costo_estimado || 0}" onchange="actualizarGasto('${gasto.id}', 'costo_estimado', this.value)"></td>
                    <td><input type="number" step="0.01" value="${gasto.costo_real || 0}" onchange="actualizarGasto('${gasto.id}', 'costo_real', this.value)"></td>
                    <td class="currency">‚Ç°${diferencia.toFixed(2)}</td>
                    <td><input type="date" value="${gasto.fecha_pago || ''}" onchange="actualizarGasto('${gasto.id}', 'fecha_pago', this.value)"></td>
                    <td><input type="text" value="${gasto.pagado_por || ''}" onchange="actualizarGasto('${gasto.id}', 'pagado_por', this.value)"></td>
                    <td><input type="text" value="${gasto.observaciones || ''}" onchange="actualizarGasto('${gasto.id}', 'observaciones', this.value)"></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarGasto('${gasto.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function actualizarTablaTareas() {
            const tbody = document.querySelector('#tablaTareas tbody');
            tbody.innerHTML = '';
            
            tareas.forEach(tarea => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${tarea.tarea || ''}" onchange="actualizarTarea('${tarea.id}', 'tarea', this.value)"></td>
                    <td>
                        <select onchange="actualizarTarea('${tarea.id}', 'categoria', this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="planificacion" ${tarea.categoria === 'planificacion' ? 'selected' : ''}>üìã Planificaci√≥n</option>
                            <option value="decoracion" ${tarea.categoria === 'decoracion' ? 'selected' : ''}>üéÄ Decoraci√≥n</option>
                            <option value="comida" ${tarea.categoria === 'comida' ? 'selected' : ''}>üçΩÔ∏è Comida</option>
                            <option value="musica" ${tarea.categoria === 'musica' ? 'selected' : ''}>üéµ M√∫sica</option>
                            <option value="invitaciones" ${tarea.categoria === 'invitaciones' ? 'selected' : ''}>üíå Invitaciones</option>
                            <option value="logistica" ${tarea.categoria === 'logistica' ? 'selected' : ''}>üöõ Log√≠stica</option>
                            <option value="otros" ${tarea.categoria === 'otros' ? 'selected' : ''}>üì¶ Otros</option>
                        </select>
                    </td>
                    <td><input type="text" value="${tarea.responsable || ''}" onchange="actualizarTarea('${tarea.id}', 'responsable', this.value)"></td>
                    <td><input type="date" value="${tarea.fecha_limite || ''}" onchange="actualizarTarea('${tarea.id}', 'fecha_limite', this.value)"></td>
                    <td>
                        <select onchange="actualizarTarea('${tarea.id}', 'prioridad', this.value)">
                            <option value="baja" ${tarea.prioridad === 'baja' ? 'selected' : ''}>üü¢ Baja</option>
                            <option value="media" ${tarea.prioridad === 'media' ? 'selected' : ''}>üü° Media</option>
                            <option value="alta" ${tarea.prioridad === 'alta' ? 'selected' : ''}>üî¥ Alta</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="actualizarTarea('${tarea.id}', 'estado', this.value)">
                            <option value="pendiente" ${tarea.estado === 'pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                            <option value="en_progreso" ${tarea.estado === 'en_progreso' ? 'selected' : ''}>üöß En Progreso</option>
                            <option value="completada" ${tarea.estado === 'completada' ? 'selected' : ''}>‚úÖ Completada</option>
                        </select>
                    </td>
                    <td><input type="text" value="${tarea.observaciones || ''}" onchange="actualizarTarea('${tarea.id}', 'observaciones', this.value)"></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarTarea('${tarea.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function actualizarTablaInvitados() {
            const tbody = document.querySelector('#tablaInvitados tbody');
            tbody.innerHTML = '';
            
            invitados.forEach(invitado => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${invitado.nombre_completo || ''}" onchange="actualizarInvitado('${invitado.id}', 'nombre_completo', this.value)"></td>
                    <td>
                        <select onchange="actualizarInvitado('${invitado.id}', 'relacion', this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="familia" ${invitado.relacion === 'familia' ? 'selected' : ''}>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</option>
                            <option value="amigos" ${invitado.relacion === 'amigos' ? 'selected' : ''}>üë• Amigos</option>
                            <option value="trabajo" ${invitado.relacion === 'trabajo' ? 'selected' : ''}>üíº Trabajo</option>
                            <option value="vecinos" ${invitado.relacion === 'vecinos' ? 'selected' : ''}>üèòÔ∏è Vecinos</option>
                            <option value="otros" ${invitado.relacion === 'otros' ? 'selected' : ''}>üë§ Otros</option>
                        </select>
                    </td>
                    <td><input type="tel" value="${invitado.telefono || ''}" onchange="actualizarInvitado('${invitado.id}', 'telefono', this.value)"></td>
                    <td><input type="email" value="${invitado.email || ''}" onchange="actualizarInvitado('${invitado.id}', 'email', this.value)"></td>
                    <td>
                        <select onchange="actualizarInvitado('${invitado.id}', 'estado', this.value)">
                            <option value="pendiente" ${invitado.estado === 'pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
                            <option value="confirmado" ${invitado.estado === 'confirmado' ? 'selected' : ''}>‚úÖ Confirmado</option>
                            <option value="no_asiste" ${invitado.estado === 'no_asiste' ? 'selected' : ''}>‚ùå No Asiste</option>
                        </select>
                    </td>
                    <td><input type="number" min="0" value="${invitado.acompanantes || 0}" onchange="actualizarInvitado('${invitado.id}', 'acompanantes', this.value)"></td>
                    <td><input type="text" value="${invitado.necesidades_especiales || ''}" onchange="actualizarInvitado('${invitado.id}', 'necesidades_especiales', this.value)"></td>
                    <td><input type="text" value="${invitado.observaciones || ''}" onchange="actualizarInvitado('${invitado.id}', 'observaciones', this.value)"></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-small" onclick="eliminarInvitado('${invitado.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Funciones CRUD
        async function agregarNuevoAporte() {
            try {
                const docRef = await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(window.firebaseDB, 'aportes'),
                    {
                        nombre: 'Nuevo familiar',
                        monto_comprometido: 0,
                        monto_entregado: 0,
                        fecha_aporte: '',
                        forma_pago: '',
                        observaciones: '',
                        created_at: new Date()
                    }
                );
                
                aportes.push({
                    id: docRef.id,
                    nombre: 'Nuevo familiar',
                    monto_comprometido: 0,
                    monto_entregado: 0,
                    fecha_aporte: '',
                    forma_pago: '',
                    observaciones: ''
                });
                
                actualizarTablaAportes();
            } catch (error) {
                console.error('Error agregando aporte:', error);
                alert('Error al agregar familiar');
            }
        }
        
        async function actualizarAporte(id, campo, valor) {
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'aportes', id),
                    { [campo]: campo.includes('monto') ? parseFloat(valor) || 0 : valor }
                );
                
                const index = aportes.findIndex(a => a.id === id);
                if (index !== -1) {
                    aportes[index][campo] = campo.includes('monto') ? parseFloat(valor) || 0 : valor;
                    actualizarTablaAportes();
                }
            } catch (error) {
                console.error('Error actualizando aporte:', error);
            }
        }
        
        async function eliminarAporte(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este aporte?')) return;
            
            try {
                await window.firebaseFunctions.deleteDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'aportes', id)
                );
                
                aportes = aportes.filter(a => a.id !== id);
                actualizarTablaAportes();
            } catch (error) {
                console.error('Error eliminando aporte:', error);
                alert('Error al eliminar aporte');
            }
        }
        
        // Funciones similares para gastos, tareas e invitados...
        async function agregarNuevoGasto() {
            try {
                const docRef = await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(window.firebaseDB, 'gastos'),
                    {
                        categoria: '',
                        proveedor: '',
                        costo_estimado: 0,
                        costo_real: 0,
                        fecha_pago: '',
                        pagado_por: '',
                        observaciones: '',
                        created_at: new Date()
                    }
                );
                
                gastos.push({
                    id: docRef.id,
                    categoria: '',
                    proveedor: '',
                    costo_estimado: 0,
                    costo_real: 0,
                    fecha_pago: '',
                    pagado_por: '',
                    observaciones: ''
                });
                
                actualizarTablaGastos();
            } catch (error) {
                console.error('Error agregando gasto:', error);
                alert('Error al agregar gasto');
            }
        }
        
        async function actualizarGasto(id, campo, valor) {
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'gastos', id),
                    { [campo]: campo.includes('costo') ? parseFloat(valor) || 0 : valor }
                );
                
                const index = gastos.findIndex(g => g.id === id);
                if (index !== -1) {
                    gastos[index][campo] = campo.includes('costo') ? parseFloat(valor) || 0 : valor;
                    actualizarTablaGastos();
                }
            } catch (error) {
                console.error('Error actualizando gasto:', error);
            }
        }
        
        async function eliminarGasto(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este gasto?')) return;
            
            try {
                await window.firebaseFunctions.deleteDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'gastos', id)
                );
                
                gastos = gastos.filter(g => g.id !== id);
                actualizarTablaGastos();
            } catch (error) {
                console.error('Error eliminando gasto:', error);
                alert('Error al eliminar gasto');
            }
        }
        
        // Funciones para tareas
        async function agregarNuevaTarea() {
            try {
                const docRef = await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(window.firebaseDB, 'tareas'),
                    {
                        tarea: 'Nueva tarea',
                        categoria: '',
                        responsable: '',
                        fecha_limite: '',
                        prioridad: 'media',
                        estado: 'pendiente',
                        observaciones: '',
                        created_at: new Date()
                    }
                );
                
                tareas.push({
                    id: docRef.id,
                    tarea: 'Nueva tarea',
                    categoria: '',
                    responsable: '',
                    fecha_limite: '',
                    prioridad: 'media',
                    estado: 'pendiente',
                    observaciones: ''
                });
                
                actualizarTablaTareas();
            } catch (error) {
                console.error('Error agregando tarea:', error);
                alert('Error al agregar tarea');
            }
        }
        
        async function actualizarTarea(id, campo, valor) {
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'tareas', id),
                    { [campo]: valor }
                );
                
                const index = tareas.findIndex(t => t.id === id);
                if (index !== -1) {
                    tareas[index][campo] = valor;
                    actualizarTablaTareas();
                }
            } catch (error) {
                console.error('Error actualizando tarea:', error);
            }
        }
        
        async function eliminarTarea(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) return;
            
            try {
                await window.firebaseFunctions.deleteDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'tareas', id)
                );
                
                tareas = tareas.filter(t => t.id !== id);
                actualizarTablaTareas();
            } catch (error) {
                console.error('Error eliminando tarea:', error);
                alert('Error al eliminar tarea');
            }
        }
        
        // Funciones para invitados
        async function agregarNuevoInvitado() {
            try {
                const docRef = await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(window.firebaseDB, 'invitados'),
                    {
                        nombre_completo: 'Nuevo invitado',
                        relacion: '',
                        telefono: '',
                        email: '',
                        estado: 'pendiente',
                        acompanantes: 0,
                        necesidades_especiales: '',
                        observaciones: '',
                        created_at: new Date()
                    }
                );
                
                invitados.push({
                    id: docRef.id,
                    nombre_completo: 'Nuevo invitado',
                    relacion: '',
                    telefono: '',
                    email: '',
                    estado: 'pendiente',
                    acompanantes: 0,
                    necesidades_especiales: '',
                    observaciones: ''
                });
                
                actualizarTablaInvitados();
            } catch (error) {
                console.error('Error agregando invitado:', error);
                alert('Error al agregar invitado');
            }
        }
        
        async function actualizarInvitado(id, campo, valor) {
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'invitados', id),
                    { [campo]: campo === 'acompanantes' ? parseInt(valor) || 0 : valor }
                );
                
                const index = invitados.findIndex(i => i.id === id);
                if (index !== -1) {
                    invitados[index][campo] = campo === 'acompanantes' ? parseInt(valor) || 0 : valor;
                    actualizarTablaInvitados();
                }
            } catch (error) {
                console.error('Error actualizando invitado:', error);
            }
        }
        
        async function eliminarInvitado(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este invitado?')) return;
            
            try {
                await window.firebaseFunctions.deleteDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'invitados', id)
                );
                
                invitados = invitados.filter(i => i.id !== id);
                actualizarTablaInvitados();
            } catch (error) {
                console.error('Error eliminando invitado:', error);
                alert('Error al eliminar invitado');
            }
        }
        
        // Funci√≥n para cambiar tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'resumen') {
                actualizarResumen();
            }
        }
        
        function actualizarResumen() {
            const totalComprometido = aportes.reduce((sum, a) => sum + (a.monto_comprometido || 0), 0);
            const totalRecibido = aportes.reduce((sum, a) => sum + (a.monto_entregado || 0), 0);
            const totalGastosEstimados = gastos.reduce((sum, g) => sum + (g.costo_estimado || 0), 0);
            const totalGastosReales = gastos.reduce((sum, g) => sum + (g.costo_real || 0), 0);
            const balance = totalRecibido - totalGastosReales;
            
            document.getElementById('resumenContent').innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h2 style="text-align: center; margin-bottom: 30px;">üìä Resumen Financiero</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                            <h3>Aportes Comprometidos</h3>
                            <p style="font-size: 2em; font-weight: bold;">‚Ç°${totalComprometido.toFixed(2)}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                            <h3>Aportes Recibidos</h3>
                            <p style="font-size: 2em; font-weight: bold;">‚Ç°${totalRecibido.toFixed(2)}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                            <h3>Gastos Estimados</h3>
                            <p style="font-size: 2em; font-weight: bold;">‚Ç°${totalGastosEstimados.toFixed(2)}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                            <h3>Gastos Reales</h3>
                            <p style="font-size: 2em; font-weight: bold;">‚Ç°${totalGastosReales.toFixed(2)}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center; grid-column: 1 / -1;">
                            <h3>Balance Final</h3>
                            <p style="font-size: 2.5em; font-weight: bold; color: ${balance >= 0 ? '#4CAF50' : '#f44336'}">‚Ç°${balance.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Funci√≥n para importar Excel
        async function importarExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const statusDiv = document.getElementById('importStatus');
            
            if (!fileInput.files[0]) {
                alert('Por favor selecciona un archivo Excel');
                return;
            }
            
            const file = fileInput.files[0];
            statusDiv.innerHTML = '<span class="loading"></span> Procesando archivo...';
            statusDiv.style.color = '#19547b';
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                let importados = {
                    aportes: 0,
                    gastos: 0,
                    tareas: 0,
                    invitados: 0
                };
                
                // Importar Aportes
                if (workbook.SheetNames.includes('Aportes')) {
                    const aportesSheet = workbook.Sheets['Aportes'];
                    const aportesData = XLSX.utils.sheet_to_json(aportesSheet, { header: 1 });
                    
                    // Saltar la primera fila (encabezados)
                    for (let i = 1; i < aportesData.length; i++) {
                        const row = aportesData[i];
                        if (row[1]) { // Si tiene nombre
                            try {
                                await window.firebaseFunctions.addDoc(
                                    window.firebaseFunctions.collection(window.firebaseDB, 'aportes'),
                                    {
                                        nombre: row[1] || '',
                                        monto_comprometido: parseFloat(row[2]) || 0,
                                        monto_entregado: parseFloat(row[3]) || 0,
                                        fecha_aporte: row[4] || '',
                                        forma_pago: row[5] || '',
                                        observaciones: row[6] || '',
                                        imported_at: new Date()
                                    }
                                );
                                importados.aportes++;
                            } catch (error) {
                                console.error('Error importando aporte:', error);
                            }
                        }
                    }
                }
                
                // Importar Gastos
                if (workbook.SheetNames.includes('Gastos')) {
                    const gastosSheet = workbook.Sheets['Gastos'];
                    const gastosData = XLSX.utils.sheet_to_json(gastosSheet, { header: 1 });
                    
                    for (let i = 1; i < gastosData.length; i++) {
                        const row = gastosData[i];
                        if (row[1]) { // Si tiene categor√≠a
                            try {
                                await window.firebaseFunctions.addDoc(
                                    window.firebaseFunctions.collection(window.firebaseDB, 'gastos'),
                                    {
                                        categoria: row[1] || '',
                                        proveedor: row[2] || '',
                                        costo_estimado: parseFloat(row[3]) || 0,
                                        costo_real: parseFloat(row[4]) || 0,
                                        fecha_pago: row[6] || '',
                                        pagado_por: row[7] || '',
                                        observaciones: row[8] || '',
                                        imported_at: new Date()
                                    }
                                );
                                importados.gastos++;
                            } catch (error) {
                                console.error('Error importando gasto:', error);
                            }
                        }
                    }
                }
                
                // Importar Tareas
                if (workbook.SheetNames.includes('Tareas')) {
                    const tareasSheet = workbook.Sheets['Tareas'];
                    const tareasData = XLSX.utils.sheet_to_json(tareasSheet, { header: 1 });
                    
                    for (let i = 1; i < tareasData.length; i++) {
                        const row = tareasData[i];
                        if (row[1]) { // Si tiene tarea
                            try {
                                await window.firebaseFunctions.addDoc(
                                    window.firebaseFunctions.collection(window.firebaseDB, 'tareas'),
                                    {
                                        tarea: row[1] || '',
                                        categoria: row[2] || '',
                                        responsable: row[3] || '',
                                        fecha_limite: row[4] || '',
                                        prioridad: row[5] || 'media',
                                        estado: row[6] || 'pendiente',
                                        observaciones: row[7] || '',
                                        imported_at: new Date()
                                    }
                                );
                                importados.tareas++;
                            } catch (error) {
                                console.error('Error importando tarea:', error);
                            }
                        }
                    }
                }
                
                // Importar Invitados
                if (workbook.SheetNames.includes('Invitados')) {
                    const invitadosSheet = workbook.Sheets['Invitados'];
                    const invitadosData = XLSX.utils.sheet_to_json(invitadosSheet, { header: 1 });
                    
                    for (let i = 1; i < invitadosData.length; i++) {
                        const row = invitadosData[i];
                        if (row[1]) { // Si tiene nombre
                            try {
                                await window.firebaseFunctions.addDoc(
                                    window.firebaseFunctions.collection(window.firebaseDB, 'invitados'),
                                    {
                                        nombre_completo: row[1] || '',
                                        relacion: row[2] || '',
                                        telefono: row[3] || '',
                                        email: row[4] || '',
                                        estado: row[5] || 'pendiente',
                                        acompanantes: parseInt(row[6]) || 0,
                                        necesidades_especiales: row[7] || '',
                                        observaciones: row[8] || '',
                                        imported_at: new Date()
                                    }
                                );
                                importados.invitados++;
                            } catch (error) {
                                console.error('Error importando invitado:', error);
                            }
                        }
                    }
                }
                
                // Recargar datos desde Firebase
                await cargarDatos();
                
                // Mostrar resultado
                statusDiv.innerHTML = `‚úÖ ¬°Importaci√≥n exitosa!<br>
                    üì• Aportes: ${importados.aportes}<br>
                    üí∏ Gastos: ${importados.gastos}<br>
                    üìù Tareas: ${importados.tareas}<br>
                    üë• Invitados: ${importados.invitados}`;
                statusDiv.style.color = '#4CAF50';
                
                // Limpiar input
                fileInput.value = '';
                
                // Mostrar alerta de √©xito
                setTimeout(() => {
                    alert(`üéâ ¬°Importaci√≥n completada!

üìä Datos importados:
‚Ä¢ Aportes: ${importados.aportes}
‚Ä¢ Gastos: ${importados.gastos}
‚Ä¢ Tareas: ${importados.tareas}
‚Ä¢ Invitados: ${importados.invitados}

Los datos ya est√°n disponibles en la nube y sincronizados en todos tus dispositivos.`);
                    
                    statusDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                console.error('Error procesando archivo:', error);
                statusDiv.innerHTML = '‚ùå Error procesando archivo';
                statusDiv.style.color = '#f44336';
                alert('Error al procesar el archivo Excel. Verifica que el formato sea correcto.');
            }
        }
        
        // Funci√≥n para exportar Excel (mejorada)
        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            
            // Hoja 1: Aportes
            const aportesData = [['ID', 'Nombre', 'Monto Comprometido', 'Monto Entregado', 'Fecha', 'Forma de Pago', 'Observaciones', 'Saldo']];
            aportes.forEach(aporte => {
                const saldo = (aporte.monto_comprometido || 0) - (aporte.monto_entregado || 0);
                aportesData.push([
                    aporte.id,
                    aporte.nombre || '',
                    aporte.monto_comprometido || 0,
                    aporte.monto_entregado || 0,
                    aporte.fecha_aporte || '',
                    aporte.forma_pago || '',
                    aporte.observaciones || '',
                    saldo
                ]);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(aportesData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Aportes');
            
            // Hoja 2: Gastos
            const gastosData = [['ID', 'Categor√≠a', 'Proveedor', 'Costo Estimado', 'Costo Real', 'Diferencia', 'Fecha Pago', 'Pagado Por', 'Observaciones']];
            gastos.forEach(gasto => {
                const diferencia = (gasto.costo_estimado || 0) - (gasto.costo_real || 0);
                gastosData.push([
                    gasto.id,
                    gasto.categoria || '',
                    gasto.proveedor || '',
                    gasto.costo_estimado || 0,
                    gasto.costo_real || 0,
                    diferencia,
                    gasto.fecha_pago || '',
                    gasto.pagado_por || '',
                    gasto.observaciones || ''
                ]);
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(gastosData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Gastos');
            
            // Hoja 3: Tareas
            const tareasData = [['ID', 'Tarea', 'Categor√≠a', 'Responsable', 'Fecha L√≠mite', 'Prioridad', 'Estado', 'Observaciones']];
            tareas.forEach(tarea => {
                tareasData.push([
                    tarea.id,
                    tarea.tarea || '',
                    tarea.categoria || '',
                    tarea.responsable || '',
                    tarea.fecha_limite || '',
                    tarea.prioridad || '',
                    tarea.estado || '',
                    tarea.observaciones || ''
                ]);
            });
            
            const ws3 = XLSX.utils.aoa_to_sheet(tareasData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Tareas');
            
            // Hoja 4: Invitados
            const invitadosData = [['ID', 'Nombre', 'Relaci√≥n', 'Tel√©fono', 'Email', 'Estado', 'Acompa√±antes', 'Necesidades Especiales', 'Observaciones']];
            invitados.forEach(invitado => {
                invitadosData.push([
                    invitado.id,
                    invitado.nombre_completo || '',
                    invitado.relacion || '',
                    invitado.telefono || '',
                    invitado.email || '',
                    invitado.estado || '',
                    invitado.acompanantes || 0,
                    invitado.necesidades_especiales || '',
                    invitado.observaciones || ''
                ]);
            });
            
            const ws4 = XLSX.utils.aoa_to_sheet(invitadosData);
            XLSX.utils.book_append_sheet(wb, ws4, 'Invitados');
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `fiesta_50_aniversario_cloud_${fecha}.xlsx`);
            alert('üìä ¬°Archivo Excel descargado exitosamente desde la nube! üéâ');
        }
        
        // Funci√≥n para mostrar ayuda de importaci√≥n
        function mostrarAyudaImportacion() {
            alert(`üì• FORMATO PARA IMPORTAR EXCEL

üìã Tu archivo Excel debe tener estas 4 hojas:

üîπ Hoja 1: "Aportes"
Columnas: ID, Nombre, Monto Comprometido, Monto Entregado, Fecha, Forma de Pago, Observaciones, Saldo

üîπ Hoja 2: "Gastos" 
Columnas: ID, Categor√≠a, Proveedor, Costo Estimado, Costo Real, Diferencia, Fecha Pago, Pagado Por, Observaciones

üîπ Hoja 3: "Tareas"
Columnas: ID, Tarea, Categor√≠a, Responsable, Fecha L√≠mite, Prioridad, Estado, Observaciones

üîπ Hoja 4: "Invitados"
Columnas: ID, Nombre, Relaci√≥n, Tel√©fono, Email, Estado, Acompa√±antes, Necesidades Especiales, Observaciones

‚ö†Ô∏è IMPORTANTE:
‚Ä¢ Los nombres de las hojas deben ser exactos
‚Ä¢ La primera fila son encabezados (se ignora)
‚Ä¢ Los datos se AGREGAN a los existentes
‚Ä¢ Formatos: .xlsx o .xls

üí° Usa "Descargar Plantilla" para obtener un ejemplo.`);
        }
        
        // Funci√≥n para descargar plantilla de Excel
        function descargarPlantilla() {
            const wb = XLSX.utils.book_new();
            
            // Plantilla Aportes
            const aportesPlantilla = [
                ['ID', 'Nombre', 'Monto Comprometido', 'Monto Entregado', 'Fecha', 'Forma de Pago', 'Observaciones', 'Saldo'],
                ['1', 'Juan P√©rez', '50000', '25000', '2025-01-15', 'transferencia', 'Pago parcial', '25000'],
                ['2', 'Mar√≠a Garc√≠a', '75000', '75000', '2025-01-20', 'efectivo', 'Pago completo', '0'],
                ['', 'Nuevo familiar', '0', '0', '', '', '', '0']
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(aportesPlantilla);
            XLSX.utils.book_append_sheet(wb, ws1, 'Aportes');
            
            // Plantilla Gastos
            const gastosPlantilla = [
                ['ID', 'Categor√≠a', 'Proveedor', 'Costo Estimado', 'Costo Real', 'Diferencia', 'Fecha Pago', 'Pagado Por', 'Observaciones'],
                ['1', 'banquete', 'Restaurante ABC', '200000', '180000', '20000', '2025-02-01', 'Juan', 'Descuento aplicado'],
                ['2', 'musica', 'DJ Party', '50000', '55000', '-5000', '2025-02-05', 'Mar√≠a', 'Equipo adicional'],
                ['', 'decoracion', 'Nuevo proveedor', '0', '0', '0', '', '', '']
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(gastosPlantilla);
            XLSX.utils.book_append_sheet(wb, ws2, 'Gastos');
            
            // Plantilla Tareas
            const tareasPlantilla = [
                ['ID', 'Tarea', 'Categor√≠a', 'Responsable', 'Fecha L√≠mite', 'Prioridad', 'Estado', 'Observaciones'],
                ['1', 'Confirmar sal√≥n', 'planificacion', 'Carlos', '2025-01-30', 'alta', 'completada', 'Ya confirmado'],
                ['2', 'Comprar decoraci√≥n', 'decoracion', 'Ana', '2025-02-10', 'media', 'pendiente', 'Buscar presupuestos'],
                ['', 'Nueva tarea', 'otros', '', '', 'media', 'pendiente', '']
            ];
            const ws3 = XLSX.utils.aoa_to_sheet(tareasPlantilla);
            XLSX.utils.book_append_sheet(wb, ws3, 'Tareas');
            
            // Plantilla Invitados
            const invitadosPlantilla = [
                ['ID', 'Nombre', 'Relaci√≥n', 'Tel√©fono', 'Email', 'Estado', 'Acompa√±antes', 'Necesidades Especiales', 'Observaciones'],
                ['1', 'Pedro L√≥pez', 'familia', '88888888', 'pedro@email.com', 'confirmado', '2', 'Sin gluten', 'Traer√° esposa e hijo'],
                ['2', 'Laura S√°nchez', 'amigos', '77777777', 'laura@email.com', 'pendiente', '0', 'Vegetariana', 'Confirmar esta semana'],
                ['', 'Nuevo invitado', 'familia', '', '', 'pendiente', '0', '', '']
            ];
            const ws4 = XLSX.utils.aoa_to_sheet(invitadosPlantilla);
            XLSX.utils.book_append_sheet(wb, ws4, 'Invitados');
            
            // Descargar plantilla
            XLSX.writeFile(wb, 'plantilla_importacion_fiesta.xlsx');
            alert(`üìÑ ¬°Plantilla descargada!

üîß INSTRUCCIONES:
1. Abre el archivo "plantilla_importacion_fiesta.xlsx"
2. Reemplaza los datos de ejemplo con tus datos reales
3. Mant√©n los nombres de las hojas exactos
4. Guarda el archivo
5. √ösalo para importar a la aplicaci√≥n

üí° La plantilla incluye ejemplos de cada tipo de dato para guiarte.`);
        }
        
        // Funci√≥n para generar reporte completo
        function generarReporteCompleto() {
            const fecha = new Date();
            const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const horaFormateada = fecha.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Calcular totales
            const totalComprometido = aportes.reduce((sum, a) => sum + (a.monto_comprometido || 0), 0);
            const totalRecibido = aportes.reduce((sum, a) => sum + (a.monto_entregado || 0), 0);
            const totalGastosEstimados = gastos.reduce((sum, g) => sum + (g.costo_estimado || 0), 0);
            const totalGastosReales = gastos.reduce((sum, g) => sum + (g.costo_real || 0), 0);
            const balance = totalRecibido - totalGastosReales;
            const saldoPendiente = totalComprometido - totalRecibido;
            
            // Estad√≠sticas de invitados
            const totalInvitados = invitados.length;
            const confirmados = invitados.filter(i => i.estado === 'confirmado').length;
            const pendientes = invitados.filter(i => i.estado === 'pendiente').length;
            const noAsisten = invitados.filter(i => i.estado === 'no_asiste').length;
            const totalAcompanantes = invitados.reduce((sum, i) => sum + (i.acompanantes || 0), 0);
            
            // Estad√≠sticas de tareas
            const totalTareas = tareas.length;
            const tareasCompletadas = tareas.filter(t => t.estado === 'completada').length;
            const tareasEnProgreso = tareas.filter(t => t.estado === 'en_progreso').length;
            const tareasPendientes = tareas.filter(t => t.estado === 'pendiente').length;
            
            const reporteHTML = `
                <div class="reporte-header">
                    <h1>üéâ Reporte de Fiesta - 50 Aniversario</h1>
                    <p>Generado el ${fechaFormateada} a las ${horaFormateada}</p>
                </div>
                
                <!-- Resumen Ejecutivo -->
                <div class="reporte-seccion">
                    <div class="reporte-resumen">
                        <h2 style="color: white; text-align: center; margin-bottom: 20px;">üìä Resumen Ejecutivo</h2>
                        <div class="reporte-resumen-grid">
                            <div class="reporte-resumen-item">
                                <h4>Aportes Comprometidos</h4>
                                <div class="valor">‚Ç°${totalComprometido.toLocaleString()}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Aportes Recibidos</h4>
                                <div class="valor">‚Ç°${totalRecibido.toLocaleString()}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Saldo Pendiente</h4>
                                <div class="valor">‚Ç°${saldoPendiente.toLocaleString()}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Gastos Estimados</h4>
                                <div class="valor">‚Ç°${totalGastosEstimados.toLocaleString()}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Gastos Reales</h4>
                                <div class="valor">‚Ç°${totalGastosReales.toLocaleString()}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Balance Final</h4>
                                <div class="valor" style="color: ${balance >= 0 ? '#4CAF50' : '#f44336'}">‚Ç°${balance.toLocaleString()}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Total Invitados</h4>
                                <div class="valor">${totalInvitados + totalAcompanantes}</div>
                            </div>
                            <div class="reporte-resumen-item">
                                <h4>Tareas Completadas</h4>
                                <div class="valor">${tareasCompletadas}/${totalTareas}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Aportes de la Familia -->
                <div class="reporte-seccion">
                    <h2>üí∞ Aportes de la Familia</h2>
                    <table class="reporte-tabla">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Monto Comprometido</th>
                                <th>Monto Entregado</th>
                                <th>Fecha</th>
                                <th>Forma de Pago</th>
                                <th>Saldo Pendiente</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aportes.map(aporte => {
                                const saldo = (aporte.monto_comprometido || 0) - (aporte.monto_entregado || 0);
                                return `
                                    <tr>
                                        <td>${aporte.nombre || ''}</td>
                                        <td>‚Ç°${(aporte.monto_comprometido || 0).toLocaleString()}</td>
                                        <td>‚Ç°${(aporte.monto_entregado || 0).toLocaleString()}</td>
                                        <td>${aporte.fecha_aporte || ''}</td>
                                        <td>${aporte.forma_pago || ''}</td>
                                        <td style="color: ${saldo > 0 ? '#d32f2f' : '#388e3c'}">‚Ç°${saldo.toLocaleString()}</td>
                                        <td>${aporte.observaciones || ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Gastos de la Fiesta -->
                <div class="reporte-seccion">
                    <h2>üí∏ Gastos de la Fiesta</h2>
                    <table class="reporte-tabla">
                        <thead>
                            <tr>
                                <th>Categor√≠a</th>
                                <th>Proveedor</th>
                                <th>Costo Estimado</th>
                                <th>Costo Real</th>
                                <th>Diferencia</th>
                                <th>Fecha Pago</th>
                                <th>Pagado Por</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${gastos.map(gasto => {
                                const diferencia = (gasto.costo_estimado || 0) - (gasto.costo_real || 0);
                                return `
                                    <tr>
                                        <td>${obtenerTextoCategoria(gasto.categoria)}</td>
                                        <td>${gasto.proveedor || ''}</td>
                                        <td>‚Ç°${(gasto.costo_estimado || 0).toLocaleString()}</td>
                                        <td>‚Ç°${(gasto.costo_real || 0).toLocaleString()}</td>
                                        <td style="color: ${diferencia >= 0 ? '#388e3c' : '#d32f2f'}">‚Ç°${diferencia.toLocaleString()}</td>
                                        <td>${gasto.fecha_pago || ''}</td>
                                        <td>${gasto.pagado_por || ''}</td>
                                        <td>${gasto.observaciones || ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Tareas -->
                <div class="reporte-seccion">
                    <h2>üìù Control de Tareas</h2>
                    <table class="reporte-tabla">
                        <thead>
                            <tr>
                                <th>Tarea</th>
                                <th>Categor√≠a</th>
                                <th>Responsable</th>
                                <th>Fecha L√≠mite</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tareas.map(tarea => `
                                <tr>
                                    <td>${tarea.tarea || ''}</td>
                                    <td>${obtenerTextoCategoriaTarea(tarea.categoria)}</td>
                                    <td>${tarea.responsable || ''}</td>
                                    <td>${tarea.fecha_limite || ''}</td>
                                    <td>${obtenerTextoPrioridad(tarea.prioridad)}</td>
                                    <td>${obtenerTextoEstado(tarea.estado)}</td>
                                    <td>${tarea.observaciones || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Invitados -->
                <div class="reporte-seccion">
                    <h2>üë• Lista de Invitados</h2>
                    <div style="margin-bottom: 20px;">
                        <strong>Resumen:</strong> 
                        Confirmados: ${confirmados} | 
                        Pendientes: ${pendientes} | 
                        No asisten: ${noAsisten} | 
                        Total con acompa√±antes: ${totalInvitados + totalAcompanantes}
                    </div>
                    <table class="reporte-tabla">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Relaci√≥n</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Estado</th>
                                <th>Acompa√±antes</th>
                                <th>Necesidades Especiales</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invitados.map(invitado => `
                                <tr>
                                    <td>${invitado.nombre_completo || ''}</td>
                                    <td>${obtenerTextoRelacion(invitado.relacion)}</td>
                                    <td>${invitado.telefono || ''}</td>
                                    <td>${invitado.email || ''}</td>
                                    <td>${obtenerTextoEstadoInvitado(invitado.estado)}</td>
                                    <td>${invitado.acompanantes || 0}</td>
                                    <td>${invitado.necesidades_especiales || ''}</td>
                                    <td>${invitado.observaciones || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="reporte-footer">
                    <p><strong>Organizador de Fiesta - 50 Aniversario</strong></p>
                    <p>Reporte generado autom√°ticamente desde la base de datos en la nube</p>
                    <p>Fecha de generaci√≥n: ${fechaFormateada} - ${horaFormateada}</p>
                </div>
            `;
            
            document.getElementById('reporteCompleto').innerHTML = reporteHTML;
            alert('üìã ¬°Reporte generado exitosamente!\n\nAhora puedes hacer clic en "üñ®Ô∏è Imprimir PDF" para descargarlo.');
        }
        
        // Funciones auxiliares para obtener texto legible
        function obtenerTextoCategoria(categoria) {
            const categorias = {
                'banquete': 'üçΩÔ∏è Banquete',
                'musica': 'üéµ M√∫sica',
                'decoracion': 'üéÄ Decoraci√≥n',
                'fotografia': 'üì∏ Fotograf√≠a',
                'otros': 'üì¶ Otros'
            };
            return categorias[categoria] || categoria || '';
        }
        
        function obtenerTextoCategoriaTarea(categoria) {
            const categorias = {
                'planificacion': 'üìã Planificaci√≥n',
                'decoracion': 'üéÄ Decoraci√≥n',
                'comida': 'üçΩÔ∏è Comida',
                'musica': 'üéµ M√∫sica',
                'invitaciones': 'üíå Invitaciones',
                'logistica': 'üöõ Log√≠stica',
                'otros': 'üì¶ Otros'
            };
            return categorias[categoria] || categoria || '';
        }
        
        function obtenerTextoPrioridad(prioridad) {
            const prioridades = {
                'baja': 'üü¢ Baja',
                'media': 'üü° Media',
                'alta': 'üî¥ Alta'
            };
            return prioridades[prioridad] || prioridad || '';
        }
        
        function obtenerTextoEstado(estado) {
            const estados = {
                'pendiente': '‚è≥ Pendiente',
                'en_progreso': 'üöß En Progreso',
                'completada': '‚úÖ Completada'
            };
            return estados[estado] || estado || '';
        }
        
        function obtenerTextoRelacion(relacion) {
            const relaciones = {
                'familia': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia',
                'amigos': 'üë• Amigos',
                'trabajo': 'üíº Trabajo',
                'vecinos': 'üèòÔ∏è Vecinos',
                'otros': 'üë§ Otros'
            };
            return relaciones[relacion] || relacion || '';
        }
        
        function obtenerTextoEstadoInvitado(estado) {
            const estados = {
                'pendiente': '‚è≥ Pendiente',
                'confirmado': '‚úÖ Confirmado',
                'no_asiste': '‚ùå No Asiste'
            };
            return estados[estado] || estado || '';
        }
        
        // Funci√≥n para imprimir reporte
        function imprimirReporte() {
            const reporte = document.getElementById('reporteCompleto');
            
            if (!reporte.innerHTML.trim()) {
                alert('‚ö†Ô∏è Primero debes generar el reporte haciendo clic en "üìã Generar Reporte Completo"');
                return;
            }
            
            // Abrir ventana de impresi√≥n
            window.print();
            
            // Mostrar instrucciones
            setTimeout(() => {
                alert(`üñ®Ô∏è INSTRUCCIONES PARA IMPRIMIR EN PDF:

üìã EN WINDOWS:
1. En la ventana de impresi√≥n, selecciona "Microsoft Print to PDF"
2. Haz clic en "Imprimir"
3. Elige d√≥nde guardar el archivo PDF

üìã EN MAC:
1. En la ventana de impresi√≥n, haz clic en "PDF"
2. Selecciona "Guardar como PDF"
3. Elige la ubicaci√≥n para guardar

üìã EN CHROME/EDGE:
1. En la ventana de impresi√≥n, cambia el destino a "Guardar como PDF"
2. Ajusta las opciones si es necesario
3. Haz clic en "Guardar"

üí° El reporte incluye todos los datos de la fiesta organizados por categor√≠as, listo para imprimir o enviar por email.`);
            }, 1000);
        }
    </script>
</body>
</html>
